### 上送的日志主要分为 3 类

- 普通日志
- 异常日志
- 用户行为

#### 普通日志

- 主要用于线上，场测环境下各种问题 debug 和错误原因分析
- 页面加载流程及设备信息的监控
  - server 端 loadConfig
  - client 端 设备信息(网络和设备信息)
  - client 端 DOMloaded
  - client 端 window onload
  - client 端 beforeunload

#### 异常日志

- 逻辑错误
- 数据类型错误
- 语法错误
- 网络错误
- 系统错误

通过一下 4 种方式进行捕获

- window.onerror   运行时错误（包括语法错误）
- unhandledrejection   promise 被 reject 且
- request error
- vue.config.errorHandler

#### 用户行为

从进入首页到完成支付

- 选择支付方式 （直接支付）
- 输入项 (点击支付按钮)
- 取消支付
- 最小化页面
- 关闭页面

#### 采集

##### 采集的日志处理成统一格式

- 收银台首页和结果页:

[时间]-[订单号]-[页面路径]-[错误信息]-[辅助错误信息]

[时间]-[订单号]-[页面路径]-[用户行为]-[用户具体行为]

[时间]-[订单号]-[页面路径]-[页面生命周期]-[页面具体生命周期]

- 登录页:

[时间]-[登录 id]-[页面路径]-[错误信息]-[辅助错误信息]

##### 异常录制 （待研究）

所谓的“异常录制”，实际上就是通过技术手段，收集用户的操作过程，对用户的每一个操作都进行记录，在发生异常时，把一定时间区间内的记录重新运行，形成影像进行播放，让调试者无需向用户询问，就能看到用户当时的操作过程。

#### 上报

如果任何日志都立即上报，这无异于自造的 DDOS 攻击。

我们采用错误日志及时上送， 普通日志定时上送。

- 及时上送，直接发送请求上送
- 定时上送， 需要前端存储日志， 综合分析 IndexedDB 是最好的选择，它具有容量大、异步的优势，异步的特性保证它不会对界面的渲染产生阻塞。而且 IndexedDB 是分库的，每个库又分 store，还能按照索引进行查询，具有完整的数据库管理思维，比 localStorage 更适合做结构化数据管理。但是它有一个缺点，就是 api 非常复杂，不像 localStorage 那么简单直接。针对这一点，我们可以使用 hello-indexeddb 这个工具，它用 Promise 对复杂 api 进行来封装，简化操作，使 IndexedDB 的使用也能做到 localStorage 一样便捷。另外，IndexedDB 是被广泛支持的 HTML5 标准，兼容大部分浏览器。

#### 日志分析

以可视化的方式给管理者和开发者反馈信息

- 用户维度，分析用户一系列操作
- 性能维度， 界面加载时间，用户呆滞时间
- 运行环境维度， 应用所在网路环境，设备信息分布

#### 告警

设置告警条件
